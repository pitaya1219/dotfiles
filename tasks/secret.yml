version: '3'

vars:
  SYNC_SCRIPT: ./scripts/proton-passage-sync.sh

tasks:
  default:
    desc: "List available secret management tasks"
    silent: true
    cmds:
      - task --list-all --taskfile tasks/secret.yml

  # ========================================
  # 同期タスク
  # ========================================

  sync:
    desc: "Bidirectional sync between Proton Pass and passage (interactive)"
    summary: |
      Sync secrets between Proton Pass (Vault: Passage) and local passage store.
      
      Usage:
        task secret:sync                    # Sync all entries
        task secret:sync PATH=homelab/gitea # Sync specific path only
      
      This is an interactive process where you manually choose which
      version to keep for each conflicting entry.
    cmds:
      - bash {{.SYNC_SCRIPT}} sync "{{.PATH}}"
    vars:
      PATH: '{{.PATH | default ""}}'

  sync:status:
    desc: "Show sync status without making changes"
    summary: |
      Display differences between Proton Pass and passage without
      making any modifications.
      
      Usage:
        task secret:sync:status
        task secret:sync:status PATH=homelab
    cmds:
      - bash {{.SYNC_SCRIPT}} status "{{.PATH}}"
    vars:
      PATH: '{{.PATH | default ""}}'

  sync:proton-to-passage:
    desc: "One-way sync: Proton Pass → passage (interactive)"
    summary: |
      Sync only from Proton Pass to passage. New entries in Proton Pass
      will be offered to create in passage. Modified entries require
      manual selection.
      
      Usage:
        task secret:sync:proton-to-passage
        task secret:sync:proton-to-passage PATH=github
    cmds:
      - bash {{.SYNC_SCRIPT}} proton-to-passage "{{.PATH}}"
    vars:
      PATH: '{{.PATH | default ""}}'

  sync:passage-to-proton:
    desc: "One-way sync: passage → Proton Pass (interactive)"
    summary: |
      Sync only from passage to Proton Pass. New entries in passage
      will be offered to create in Proton Pass. Modified entries
      require manual selection.
      
      Usage:
        task secret:sync:passage-to-proton
        task secret:sync:passage-to-proton PATH=homelab/gitea
    cmds:
      - bash {{.SYNC_SCRIPT}} passage-to-proton "{{.PATH}}"
    vars:
      PATH: '{{.PATH | default ""}}'

  # ========================================
  # 初期セットアップ
  # ========================================

  init:proton:
    desc: "Initialize Proton Pass from passage (first-time setup)"
    summary: |
      Create "Passage" vault in Proton Pass and import all entries
      from local passage store.
      
      This is a one-time setup operation. After this, use 'task secret:sync'
      for ongoing synchronization.
      
      Prerequisites:
        - pass-cli installed and authenticated (run: pass-cli login)
        - passage store populated with entries
    prompt: "This will create a 'Passage' vault in Proton Pass and import all passage entries. Continue?"
    cmds:
      - bash {{.SYNC_SCRIPT}} init-proton

  init:passage:
    desc: "Initialize passage from Proton Pass (reverse import)"
    summary: |
      Import all entries from Proton Pass "Passage" vault into local
      passage store.
      
      WARNING: This will overwrite existing passage entries with the
      same path. Use with caution.
    prompt: "This will import all Proton Pass entries into passage, potentially overwriting existing entries. Continue?"
    cmds:
      - bash {{.SYNC_SCRIPT}} init-passage

  # ========================================
  # ユーティリティ
  # ========================================

  check:
    desc: "Check prerequisites and authentication status"
    summary: |
      Verify that all required tools are installed and properly
      configured:
        - pass-cli (Proton Pass CLI)
        - passage
        - jq
        - Proton Pass authentication status
        - passage GPG key access
    cmds:
      - bash {{.SYNC_SCRIPT}} check

  vault:create:
    desc: "Create 'Passage' vault in Proton Pass"
    cmds:
      - pass-cli vault create --name "Passage"

  vault:list:
    desc: "List all Proton Pass vaults"
    cmds:
      - pass-cli vault list

  item:list:
    desc: "List items in Proton Pass 'Passage' vault"
    cmds:
      - |
        vault_id=$(pass-cli vault list --format json | jq -r '.[] | select(.name=="Passage") | .id')
        if [ -z "$vault_id" ]; then
          echo "Error: 'Passage' vault not found. Run: task secret:vault:create"
          exit 1
        fi
        pass-cli item list --vault "$vault_id"

  passage:list:
    desc: "List all passage entries"
    cmds:
      - passage list
