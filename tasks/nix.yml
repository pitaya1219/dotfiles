version: '3'

tasks:
  default:
    cmds:
      - task --list-all
    silent: true
  clean:
    desc: Clean up Nix store
    silent: true
    cmds:
      - |
        nix store gc
  upgrade:
    desc: Update Nix flake inputs and rebuild
    cmds:
      - |
        echo "Updating flake inputs..."
        nix flake update
        echo "Rebuilding configuration..."
        nix run home-manager/master -- switch --flake .#{{.USER}}
  rollback:
    desc: Rollback home-manager to previous generation
    silent: true
    cmds:
      - |
        echo "üîÑ Rolling back home-manager to previous generation..."
        # Source Nix profile if it exists
        if [ -f ~/.nix-profile/etc/profile.d/nix.sh ]; then
          source ~/.nix-profile/etc/profile.d/nix.sh
        fi

        # List recent generations
        echo "üìã Recent home-manager generations:"
        nix profile history --profile ~/.local/state/nix/profiles/home-manager | sed -n '1,10p'

        # Perform rollback
        echo ""
        echo "‚è™ Performing rollback..."
        nix profile rollback --profile ~/.local/state/nix/profiles/home-manager

        echo "‚úÖ Rollback complete!"
        echo ""
        echo "Current generation:"
        nix profile history --profile ~/.local/state/nix/profiles/home-manager | sed -n '1,3p'
  get_github_hash:*:*:*:
    desk:
    silent: true
    vars:
      OWNER: "{{index .MATCH 0}}"
      REPO: "{{index .MATCH 1}}"
      REVISION: "{{index .MATCH 2}}"
    cmds:
      - |
        nix-prefetch-url --unpack https://github.com/{{.OWNER}}/{{.REPO}}/archive/{{.REVISION}}.tar.gz
