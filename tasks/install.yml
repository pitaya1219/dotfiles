version: '3'

tasks:
  default:
    desc: Install all dependencies
    silent: true
    cmds:
      - task: git
      - task: dropbear
      - task: proot
      - task: termux-packages
      - task: nix
  git:
    desc: Install Git
    silent: true
    cmds:
      - |
        echo "ğŸ”§ Installing Git..."
        case "{{.UNAME_S}}" in
          Darwin)
            if ! command -v git >/dev/null 2>&1; then
              if command -v brew >/dev/null 2>&1; then
                brew install git;
              else
                echo "âŒ Homebrew not found. Please install Homebrew first or install Git manually.";
                exit 1;
              fi
            else
              echo "âœ… Git is already installed";
            fi
            ;;
          Linux)
            if ! command -v git >/dev/null 2>&1; then
              if command -v apt-get >/dev/null 2>&1; then
                if command -v sudo >/dev/null 2>&1; then
                  sudo apt-get update && sudo apt-get install -y git;
                else
                  echo "âš ï¸  No sudo access detected. Attempting to install without sudo...";
                  apt-get update && apt-get install -y git || {
                    echo "âŒ Failed to install Git without sudo. Please install Git manually or run with sudo access.";
                    exit 1;
                  };
                fi
              else
                echo "âŒ Unsupported package manager. Please install Git manually.";
                exit 1;
              fi
            else
              echo "âœ… Git is already installed";
            fi
            ;;
          *)
            echo "âŒ Unsupported operating system: {{.UNAME_S}}"
            exit 1
            ;;
        esac
  dropbear:
    desc: Install Dropbear (Light Weight SSH)
    silent: true
    cmds:
      - |
        echo "ğŸ”§ Installing Dropbear..."
        case "{{.UNAME_S}}" in
          Darwin)
            if ! command -v dropbear >/dev/null 2>&1; then
              echo "âŒ Dropbear should be pre-installed on macOS. Please check your system.";
              exit 1;
            else
              echo "âœ… Dropbear is already available";
            fi
            ;;
          Linux)
            if ! command -v dropbear >/dev/null 2>&1; then
              if command -v apt-get >/dev/null 2>&1; then
                if command -v sudo >/dev/null 2>&1; then
                  sudo apt-get update && sudo apt-get install -y dropbear;
                else
                  echo "âš ï¸  No sudo access detected. Attempting to install without sudo...";
                  apt-get update && apt-get install -y dropbear || {
                    echo "âŒ Failed to install Dropbear without sudo. Please install Dropbear manually or run with sudo access.";
                    exit 1;
                  };
                fi
              else
                echo "âŒ Unsupported package manager. Please install Dropbear manually.";
                exit 1;
              fi
            else
              echo "âœ… Dropbear is already installed";
            fi
            ;;
          *)
            echo "âŒ Unsupported operating system: {{.UNAME_S}}"
            exit 1
            ;;
        esac
  proot:
    desc: Install proot (for Termux environments)
    silent: true
    cmds:
      - |
        echo "ğŸ”§ Installing proot..."
        case "{{.UNAME_S}}" in
          Darwin)
            echo "âš ï¸  proot is not needed on macOS";
            ;;
          Linux)
            if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
              if ! command -v proot >/dev/null 2>&1; then
                if command -v pkg >/dev/null 2>&1; then
                  pkg update && pkg install -y proot;
                elif command -v apt-get >/dev/null 2>&1; then
                  apt-get update && apt-get install -y proot;
                else
                  echo "âŒ No suitable package manager found for proot installation.";
                  exit 1;
                fi
              else
                echo "âœ… proot is already installed";
              fi
            else
              echo "âš ï¸  proot installation skipped (not in Termux environment)";
            fi
            ;;
          *)
            echo "âŒ Unsupported operating system: {{.UNAME_S}}"
            exit 1
            ;;
        esac
  termux-packages:
    desc: Install termux-api and termux-services (for Termux environments)
    silent: true
    cmds:
      - |
        echo "ğŸ”§ Installing termux-api and termux-services..."
        case "{{.UNAME_S}}" in
          Darwin)
            echo "âš ï¸  termux-api and termux-services are not needed on macOS";
            ;;
          Linux)
            if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
              INSTALLED=0
              if ! command -v termux-battery-status >/dev/null 2>&1; then
                if command -v pkg >/dev/null 2>&1; then
                  pkg update && pkg install -y termux-api;
                  INSTALLED=1
                elif command -v apt-get >/dev/null 2>&1; then
                  apt-get update && apt-get install -y termux-api;
                  INSTALLED=1
                else
                  echo "âŒ No suitable package manager found for termux-api installation.";
                  exit 1;
                fi
              else
                echo "âœ… termux-api is already installed";
              fi
              if ! command -v sv >/dev/null 2>&1 && ! [ -d "$PREFIX/var/service" ]; then
                if command -v pkg >/dev/null 2>&1; then
                  pkg update && pkg install -y termux-services;
                  INSTALLED=1
                elif command -v apt-get >/dev/null 2>&1; then
                  apt-get update && apt-get install -y termux-services;
                  INSTALLED=1
                else
                  echo "âŒ No suitable package manager found for termux-services installation.";
                  exit 1;
                fi
              else
                echo "âœ… termux-services is already installed";
              fi
              if [ $INSTALLED -eq 1 ]; then
                echo "";
                echo "âš ï¸  Please restart Termux to activate termux-services.";
                echo "";
              fi
            else
              echo "âš ï¸  termux-api and termux-services installation skipped (not in Termux environment)";
            fi
            ;;
          *)
            echo "âŒ Unsupported operating system: {{.UNAME_S}}"
            exit 1
            ;;
        esac
  nix:
    desc: Install Nix
    silent: true
    cmds:
      - |
        echo "ğŸ”§ Installing Nix package manager..."
        if ! command -v nix >/dev/null 2>&1; then
          echo "ğŸ“¥ Downloading and installing Nix...";
          curl --proto '=https' --tlsv1.2 -L https://nixos.org/nix/install | sh;
          echo "";
          echo "âš ï¸  Please restart your shell or run:";
          echo "    source ~/.nix-profile/etc/profile.d/nix.sh";
          echo "";
        else
          echo "âœ… Nix is already installed";
          nix --version;
        fi
  check-deps:
    desc: Check if all dependencies are installed
    silent: true
    cmds:
      - |
        echo "ğŸ” Checking dependencies..."
        echo -n "Git: "
        if command -v git >/dev/null 2>&1; then
          echo "âœ… $(git --version)";
        else
          echo "âŒ Not installed";
        fi
        echo -n "Dropbear: "
        if command -v dropbear >/dev/null 2>&1; then
          echo "âœ… $(dropbear --version 2>&1 | head -n1)";
        else
          echo "âŒ Not installed";
        fi
        echo -n "proot: "
        if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
          if command -v proot >/dev/null 2>&1; then
            echo "âœ… $(proot --version 2>&1 | head -n1)";
          else
            echo "âŒ Not installed";
          fi
        else
          echo "âš ï¸  Not needed (not in Termux)";
        fi
        echo -n "Nix: "
        if command -v nix >/dev/null 2>&1; then
          echo "âœ… $(nix --version)";
        else
          echo "âŒ Not installed";
        fi
