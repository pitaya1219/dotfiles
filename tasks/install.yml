version: '3'

tasks:
  default:
    desc: Install all dependencies
    silent: true
    cmds:
      - task: git
      - task: dropbear
      - task: proot
      - task: bare-termux
      - task: nix
  git:
    desc: Install Git
    silent: true
    cmds:
      - |
        echo "üîß Installing Git..."
        case "{{.UNAME_S}}" in
          Darwin)
            if ! command -v git >/dev/null 2>&1; then
              if command -v brew >/dev/null 2>&1; then
                brew install git;
              else
                echo "‚ùå Homebrew not found. Please install Homebrew first or install Git manually.";
                exit 1;
              fi
            else
              echo "‚úÖ Git is already installed";
            fi
            ;;
          Linux)
            if ! command -v git >/dev/null 2>&1; then
              if command -v apt-get >/dev/null 2>&1; then
                if command -v sudo >/dev/null 2>&1; then
                  sudo apt-get update && sudo apt-get install -y git;
                else
                  echo "‚ö†Ô∏è  No sudo access detected. Attempting to install without sudo...";
                  apt-get update && apt-get install -y git || {
                    echo "‚ùå Failed to install Git without sudo. Please install Git manually or run with sudo access.";
                    exit 1;
                  };
                fi
              else
                echo "‚ùå Unsupported package manager. Please install Git manually.";
                exit 1;
              fi
            else
              echo "‚úÖ Git is already installed";
            fi
            ;;
          *)
            echo "‚ùå Unsupported operating system: {{.UNAME_S}}"
            exit 1
            ;;
        esac
  dropbear:
    desc: Install Dropbear (Light Weight SSH)
    silent: true
    cmds:
      - |
        echo "üîß Installing Dropbear..."
        case "{{.UNAME_S}}" in
          Darwin)
            if ! command -v dropbear >/dev/null 2>&1; then
              echo "‚ùå Dropbear should be pre-installed on macOS. Please check your system.";
              exit 1;
            else
              echo "‚úÖ Dropbear is already available";
            fi
            ;;
          Linux)
            if ! command -v dropbear >/dev/null 2>&1; then
              if command -v apt-get >/dev/null 2>&1; then
                if command -v sudo >/dev/null 2>&1; then
                  sudo apt-get update && sudo apt-get install -y dropbear;
                else
                  echo "‚ö†Ô∏è  No sudo access detected. Attempting to install without sudo...";
                  apt-get update && apt-get install -y dropbear || {
                    echo "‚ùå Failed to install Dropbear without sudo. Please install Dropbear manually or run with sudo access.";
                    exit 1;
                  };
                fi
              else
                echo "‚ùå Unsupported package manager. Please install Dropbear manually.";
                exit 1;
              fi
            else
              echo "‚úÖ Dropbear is already installed";
            fi
            ;;
          *)
            echo "‚ùå Unsupported operating system: {{.UNAME_S}}"
            exit 1
            ;;
        esac
  proot:
    desc: Install proot (for Termux environments)
    silent: true
    cmds:
      - |
        echo "üîß Installing proot..."
        case "{{.UNAME_S}}" in
          Darwin)
            echo "‚ö†Ô∏è  proot is not needed on macOS";
            ;;
          Linux)
            if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
              if ! command -v proot >/dev/null 2>&1; then
                if command -v pkg >/dev/null 2>&1; then
                  pkg update && pkg install -y proot;
                elif command -v apt-get >/dev/null 2>&1; then
                  apt-get update && apt-get install -y proot;
                else
                  echo "‚ùå No suitable package manager found for proot installation.";
                  exit 1;
                fi
              else
                echo "‚úÖ proot is already installed";
              fi
            else
              echo "‚ö†Ô∏è  proot installation skipped (not in Termux environment)";
            fi
            ;;
          *)
            echo "‚ùå Unsupported operating system: {{.UNAME_S}}"
            exit 1
            ;;
        esac
  termux-packages:
    desc: Install termux-api and termux-services (for Termux environments)
    silent: true
    cmds:
      - |
        echo "üîß Installing termux-api and termux-services..."
        case "{{.UNAME_S}}" in
          Darwin)
            echo "‚ö†Ô∏è  termux-api and termux-services are not needed on macOS";
            ;;
          Linux)
            if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
              INSTALLED=0
              if ! command -v termux-battery-status >/dev/null 2>&1; then
                if command -v pkg >/dev/null 2>&1; then
                  pkg update && pkg install -y termux-api;
                  INSTALLED=1
                elif command -v apt-get >/dev/null 2>&1; then
                  apt-get update && apt-get install -y termux-api;
                  INSTALLED=1
                else
                  echo "‚ùå No suitable package manager found for termux-api installation.";
                  exit 1;
                fi
              else
                echo "‚úÖ termux-api is already installed";
              fi
              if ! command -v sv >/dev/null 2>&1 && ! [ -d "$PREFIX/var/service" ]; then
                if command -v pkg >/dev/null 2>&1; then
                  pkg update && pkg install -y termux-services;
                  INSTALLED=1
                elif command -v apt-get >/dev/null 2>&1; then
                  apt-get update && apt-get install -y termux-services;
                  INSTALLED=1
                else
                  echo "‚ùå No suitable package manager found for termux-services installation.";
                  exit 1;
                fi
              else
                echo "‚úÖ termux-services is already installed";
              fi
              if [ $INSTALLED -eq 1 ]; then
                echo "";
                echo "‚ö†Ô∏è  Please restart Termux to activate termux-services.";
                echo "";
              fi
            else
              echo "‚ö†Ô∏è  termux-api and termux-services installation skipped (not in Termux environment)";
            fi
            ;;
          *)
            echo "‚ùå Unsupported operating system: {{.UNAME_S}}"
            exit 1
            ;;
        esac
  nix:
    desc: Install Nix
    silent: true
    cmds:
      - |
        echo "üîß Installing Nix package manager..."
        if ! command -v nix >/dev/null 2>&1; then
          echo "üì• Downloading and installing Nix...";
          curl --proto '=https' --tlsv1.2 -L https://nixos.org/nix/install | sh;
          echo "";
          echo "‚ö†Ô∏è  Please restart your shell or run:";
          echo "    source ~/.nix-profile/etc/profile.d/nix.sh";
          echo "";
        else
          echo "‚úÖ Nix is already installed";
          nix --version;
        fi
  bare-termux:
    desc: Install rclone and passage for bare Termux (without proot)
    silent: true
    cmds:
      - task: rclone
      - task: passage
      - task: rclone-secure
      - task: termux-packages
  rclone-secure:
    desc: Setup rclone-secure wrapper for bare Termux
    silent: true
    cmds:
      - |
        echo "‚òÅÔ∏è  Setting up rclone-secure..."

        # Check dependencies
        if ! command -v rclone &> /dev/null || ! command -v passage &> /dev/null; then
            echo "‚ùå Missing dependencies. Run: task install:bare-termux"
            exit 1
        fi

        # Get profile name
        read -p "Enter profile name (default: ${USER}): " profile_name
        profile_name=${profile_name:-${USER}}

        # Create bin directory and install script (use $PREFIX for Termux)
        mkdir -p $PREFIX/bin
        sed -e "s|__PROFILE_NAME__|$profile_name|g" \
            -e "s|__RCLONE_BIN__|$(command -v rclone)|g" \
            "{{.ROOT_DIR}}/scripts/rclone-secure.sh.template" > $PREFIX/bin/rclone-secure
        chmod +x $PREFIX/bin/rclone-secure

        echo "‚úÖ Installed: $PREFIX/bin/rclone-secure (profile: $profile_name)"
        echo ""
        echo "Next: Configure passage secrets and test with 'rclone-secure listremotes'"
  rclone:
    desc: Install rclone (for bare Termux)
    silent: true
    cmds:
      - |
        echo "üîß Installing rclone..."
        case "{{.UNAME_S}}" in
          Linux)
            if ! command -v rclone >/dev/null 2>&1; then
              if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
                if command -v pkg >/dev/null 2>&1; then
                  pkg update && pkg install -y rclone;
                elif command -v apt-get >/dev/null 2>&1; then
                  apt-get update && apt-get install -y rclone;
                else
                  echo "‚ùå No suitable package manager found.";
                  exit 1;
                fi
              else
                echo "‚ùå This task is for Termux environments only.";
                exit 1;
              fi
            else
              echo "‚úÖ rclone is already installed";
            fi
            ;;
          *)
            echo "‚ùå Unsupported operating system: {{.UNAME_S}}"
            exit 1
            ;;
        esac
  passage:
    desc: Install passage (for bare Termux)
    silent: true
    cmds:
      - |
        echo "üîß Installing passage..."
        case "{{.UNAME_S}}" in
          Linux)
            if ! command -v passage >/dev/null 2>&1; then
              if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
                if command -v pkg >/dev/null 2>&1; then
                  pkg update && pkg install -y passage;
                elif command -v apt-get >/dev/null 2>&1; then
                  apt-get update && apt-get install -y passage;
                else
                  echo "‚ùå No suitable package manager found.";
                  exit 1;
                fi
              else
                echo "‚ùå This task is for Termux environments only.";
                exit 1;
              fi
            else
              echo "‚úÖ passage is already installed";
            fi
            ;;
          *)
            echo "‚ùå Unsupported operating system: {{.UNAME_S}}"
            exit 1
            ;;
        esac
  check-deps:
    desc: Check if all dependencies are installed
    silent: true
    cmds:
      - |
        echo "üîç Checking dependencies..."
        echo -n "Git: "
        if command -v git >/dev/null 2>&1; then
          echo "‚úÖ $(git --version)";
        else
          echo "‚ùå Not installed";
        fi
        echo -n "Dropbear: "
        if command -v dropbear >/dev/null 2>&1; then
          echo "‚úÖ $(dropbear --version 2>&1 | head -n1)";
        else
          echo "‚ùå Not installed";
        fi
        echo -n "proot: "
        if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
          if command -v proot >/dev/null 2>&1; then
            echo "‚úÖ $(proot --version 2>&1 | head -n1)";
          else
            echo "‚ùå Not installed";
          fi
        else
          echo "‚ö†Ô∏è  Not needed (not in Termux)";
        fi
        echo -n "Nix: "
        if command -v nix >/dev/null 2>&1; then
          echo "‚úÖ $(nix --version)";
        else
          echo "‚ùå Not installed";
        fi
        echo -n "rclone: "
        if command -v rclone >/dev/null 2>&1; then
          echo "‚úÖ $(rclone --version 2>&1 | head -n1)";
        else
          echo "‚ùå Not installed";
        fi
        echo -n "passage: "
        if command -v passage >/dev/null 2>&1; then
          echo "‚úÖ Installed";
        else
          echo "‚ùå Not installed";
        fi
        echo -n "termux-api: "
        if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
          if command -v termux-battery-status >/dev/null 2>&1; then
            echo "‚úÖ Installed";
          else
            echo "‚ùå Not installed";
          fi
        else
          echo "‚ö†Ô∏è  Not needed (not in Termux)";
        fi
        echo -n "termux-services: "
        if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
          if command -v sv >/dev/null 2>&1 || [ -d "$PREFIX/var/service" ]; then
            echo "‚úÖ Installed";
          else
            echo "‚ùå Not installed";
          fi
        else
          echo "‚ö†Ô∏è  Not needed (not in Termux)";
        fi
        echo -n "rclone-secure: "
        if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
          if command -v rclone-secure >/dev/null 2>&1; then
            echo "‚úÖ Installed";
          else
            echo "‚ùå Not installed";
          fi
        else
          echo "‚ö†Ô∏è  Not needed (not in Termux)";
        fi
